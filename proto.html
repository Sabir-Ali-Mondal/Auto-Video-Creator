<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Visualization SuperSuite — Single File</title>

  <!-- Core libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/chartjs-chart-venn@4.1.0/build/index.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/controls/OrbitControls.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" /><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg1:#0b1020; --bg2:#0f1224; --panel:rgba(255,255,255,.06); --panel-b:rgba(255,255,255,.16);
      --txt:#e5e7eb; --muted:#9aa1b2; --pri:#8b5cf6; --sec:#06b6d4; --tri:#f59e0b; --qua:#10b981; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 1200px at 10% -20%,#1b1e36 0%,#0b1020 40%,#070a16 100%);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
    .glass{background:var(--panel);backdrop-filter:blur(16px);border:1px solid var(--panel-b);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    #selection{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
    #selection h1{margin:0 0 8px;font-size:clamp(28px,4vw,56px);font-weight:800;letter-spacing:-.02em}
    #selection p{margin:0 0 28px;color:var(--muted)}
    .modes{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;max-width:1200px}
    .card{width:300px;padding:18px;cursor:pointer;transition:transform .2s, box-shadow .2s}
    .card:hover{transform:translateY(-6px);box-shadow:0 16px 50px rgba(0,0,0,.35)}
    .card h3{margin:0 0 6px}
    .bar{position:fixed;left:16px;right:16px;top:16px;display:flex;gap:12px;align-items:center;z-index:10}
    .btn{border:1px solid var(--panel-b);background:rgba(255,255,255,.06);color:var(--txt);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{background:rgba(255,255,255,.1)}
    .btn.pri{background:var(--pri);border-color:transparent}
    .btn.warn{background:var(--tri);border-color:transparent;color:#111827}
    .btn.ok{background:var(--qua);border-color:transparent;color:#062716}
    .cols{position:fixed;inset:70px 16px 16px 16px;display:flex;gap:16px}
    .left{width:38%;min-width:360px;display:flex;flex-direction:column}
    .right{flex:1;display:flex}
    .sect{padding:14px;border-radius:16px}
    .sect h4{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    textarea{flex:1;min-height:200px;background:transparent;border:1px solid var(--panel-b);border-radius:12px;padding:12px;color:var(--txt);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #player{position:relative;flex:1;border-radius:16px;overflow:hidden}
    #stage{position:absolute;inset:0}
    #hud{position:absolute;inset:auto 10px 10px 10px;display:flex;gap:10px;justify-content:center}
    #note{position:fixed;right:16px;top:70px;display:flex;flex-direction:column;gap:8px;z-index:20}
    .toast{padding:10px 12px;border-radius:8px;font-weight:700}
    .t-info{background:#0ea5e9;color:white}.t-ok{background:#10b981;color:white}.t-err{background:#ef4444;color:white}
    .tag{display:inline-flex;gap:8px;align-items:center;padding:2px 10px;border-radius:999px;border:1px solid var(--panel-b);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
    .legend{position:absolute;left:10px;top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .mini{position:absolute;right:10px;top:10px;background:rgba(0,0,0,.35);padding:8px;border-radius:10px}
    .mini h5{margin:0 0 5px;font-size:12px;color:#cbd5e1}
    .mini canvas{width:220px;height:80px;display:block}
    .flex{display:flex;gap:8px;align-items:center}
    .row{display:flex;gap:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Selection -->
  <section id="selection">
    <h1>AI Visualization SuperSuite</h1>
    <p>Choose a mode and paste JSON or use templates to generate ultra-powerful, immersive visualizations.</p>
    <div class="modes">
      <div class="card glass" data-mode="graph-pro" style="border-left:4px solid var(--pri)">
        <h3>Graph Presentation Pro</h3><div class="tag"><i class="bi bi-graph-up"></i> Real-time • 3D • Predictive</div>
        <p>Streams live data, morphs chart types, projects 3D landscapes, and forecasts trends.</p>
      </div>
      <div class="card glass" data-mode="creative-pro" style="border-left:4px solid var(--sec)">
        <h3>Creative Video Pro</h3><div class="tag"><i class="bi bi-stars"></i> Compositing • Audio Reactive • FX</div>
        <p>Layered video, chroma key, particles, generative visuals driven by beats and narration.</p>
      </div>
      <div class="card glass" data-mode="mindvoice-pro" style="border-left:4px solid var(--tri)">
        <h3>MindVoice Map Pro</h3><div class="tag"><i class="bi bi-diagram-3"></i> Physics • 3D • Insights</div>
        <p>Organic growth maps, semantic links, podcast narration, collaborative edits.</p>
      </div>
      <div class="card glass" data-mode="chem-pro" style="border-left:4px solid var(--qua)">
        <h3>Chem Mechanism Pro</h3><div class="tag"><i class="bi bi-bezier2"></i> 2D→3D • Energy • Dynamics</div>
        <p>Ball-and-stick 3D, reaction energy curves, strain interactions, time scaling.</p>
      </div>
      <div class="card glass" data-mode="spacetime" style="border-left:4px solid #f43f5e">
        <h3>Space-Time</h3><div class="tag"><i class="bi bi-planet"></i> Relativity • Cosmic Web</div>
        <p>4D illusions, gravitational lensing shaders, galaxy fields.</p>
      </div>
      <div class="card glass" data-mode="biovis" style="border-left:4px solid #22d3ee">
        <h3>BioVisualization</h3><div class="tag"><i class="bi bi-activity"></i> DNA • Cells • Systems</div>
        <p>DNA helix, protein chains, cellular flows, ecosystems.</p>
      </div>
      <div class="card glass" data-mode="timeline" style="border-left:4px solid #facc15">
        <h3>Historical Timeline</h3><div class="tag"><i class="bi bi-hourglass-split"></i> Branching • Causality</div>
        <p>3D epochs, event trees, counterfactual paths.</p>
      </div>
      <div class="card glass" data-mode="simulator" style="border-left:4px solid #34d399">
        <h3>Interactive Simulator</h3><div class="tag"><i class="bi bi-cpu"></i> Systems • Scenarios</div>
        <p>Economy, climate, epidemiology with live parameters.</p>
      </div>
    </div>
  </section>

  <!-- Top bar -->
  <div class="bar">
    <button class="btn" id="backBtn"><i class="bi bi-arrow-left"></i> Back</button>
    <span class="tag" id="modeTag"><i class="bi bi-app"></i> Mode: —</span>
    <div style="flex:1"></div>
    <button class="btn" id="aiPromptBtn"><i class="bi bi-sparkles"></i> Prompt</button>
    <button class="btn" id="templateBtn"><i class="bi bi-filetype-json"></i> Template</button>
    <button class="btn ok" id="formatBtn"><i class="bi bi-magic"></i> Format</button>
    <button class="btn pri" id="runBtn"><i class="bi bi-play-fill"></i> Play</button>
    <button class="btn" id="fsBtn" title="Fullscreen"><i class="bi bi-arrows-fullscreen"></i></button>
  </div>

  <!-- Main columns -->
  <div class="cols hidden" id="main">
    <div class="left glass sect">
      <h4>Script JSON</h4>
      <div class="grid">
        <input class="glass" id="topic" placeholder="Topic or dataset (optional)" style="padding:10px;border-radius:10px;border:1px solid var(--panel-b);background:rgba(255,255,255,.06);color:var(--txt)" />
        <select class="glass" id="voice" style="padding:10px;border-radius:10px;border:1px solid var(--panel-b);background:rgba(255,255,255,.06);color:var(--txt)">
          <option value="auto">Voice: Auto</option>
          <option value="male">Voice: Male</option>
          <option value="female">Voice: Female</option>
        </select>
      </div>
      <textarea id="json" spellcheck="false" placeholder="// Paste or edit JSON here..."></textarea>
      <div class="row">
        <button class="btn" id="copyBtn"><i class="bi bi-clipboard"></i> Copy</button>
        <button class="btn warn" id="saveBtn"><i class="bi bi-download"></i> Save HTML</button>
      </div>
    </div>
    <div class="right glass sect" id="player">
      <div id="stage"></div>
      <div class="legend" id="legend"></div>
      <div class="mini hidden" id="miniPanel">
        <h5>Energy / Signal</h5>
        <canvas id="miniCanvas" width="440" height="160"></canvas>
      </div>
      <div id="hud" class="flex">
        <button class="btn" id="prevBtn"><i class="bi bi-skip-start-fill"></i></button>
        <button class="btn pri" id="playBtn"><i class="bi bi-play-fill"></i></button>
        <button class="btn" id="nextBtn"><i class="bi bi-skip-end-fill"></i></button>
        <button class="btn" id="muteBtn"><i class="bi bi-volume-up"></i></button>
        <div class="tag" id="timeTag"><i class="bi bi-clock"></i> 00:00</div>
      </div>
    </div>
  </div>

  <div id="note"></div>

  <script>
    // Util: notifications
    const Note = {
      box: document.getElementById('note'),
      show(msg, type='info', ms=2200){
        const div = document.createElement('div');
        div.className = `toast t-${type}`;
        div.textContent = msg;
        this.box.appendChild(div);
        setTimeout(()=>{ div.remove(); }, ms);
      }
    };

    // Globals
    const UI = {
      selection: document.getElementById('selection'),
      main: document.getElementById('main'),
      stage: document.getElementById('stage'),
      legend: document.getElementById('legend'),
      mini: document.getElementById('miniPanel'),
      miniCanvas: document.getElementById('miniCanvas'),
      modeTag: document.getElementById('modeTag'),
      runBtn: document.getElementById('runBtn'),
      fsBtn: document.getElementById('fsBtn'),
      playBtn: document.getElementById('playBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      muteBtn: document.getElementById('muteBtn'),
      backBtn: document.getElementById('backBtn'),
      aiPromptBtn: document.getElementById('aiPromptBtn'),
      templateBtn: document.getElementById('templateBtn'),
      formatBtn: document.getElementById('formatBtn'),
      copyBtn: document.getElementById('copyBtn'),
      saveBtn: document.getElementById('saveBtn'),
      json: document.getElementById('json'),
      topic: document.getElementById('topic'),
      voice: document.getElementById('voice'),
      timeTag: document.getElementById('timeTag')
    };

    const App = { mode:null, player:null, t0:0, speaking:false, muted:false, raf:0 };

    // Mode selection
    document.querySelectorAll('.card').forEach(el=>{
      el.addEventListener('click', ()=>{
        App.mode = el.dataset.mode;
        UI.modeTag.innerHTML = `<i class="bi bi-app"></i> Mode: ${App.mode}`;
        UI.selection.classList.add('hidden');
        UI.main.classList.remove('hidden');
        UI.json.value = JSON.stringify(Templates[App.mode], null, 2);
        Note.show('Template loaded', 'ok');
      });
    });

    // Buttons
    UI.runBtn.onclick = () => startRun();
    UI.playBtn.onclick = () => App.player?.toggle?.();
    UI.prevBtn.onclick = () => App.player?.prev?.();
    UI.nextBtn.onclick = () => App.player?.next?.();
    UI.muteBtn.onclick = () => {
      App.muted = !App.muted;
      UI.muteBtn.innerHTML = `<i class="bi ${App.muted?'bi-volume-mute':'bi-volume-up'}"></i>`;
      if (App.muted) speechSynthesis.cancel();
    };
    UI.backBtn.onclick = () => {
      stopRun();
      UI.selection.classList.remove('hidden');
      UI.main.classList.add('hidden');
      App.mode = null;
    };
    UI.aiPromptBtn.onclick = () => {
      if (!App.mode) return Note.show('Choose mode first','err');
      const topic = UI.topic.value.trim() || 'Untitled Topic';
      const prompt = Prompts[App.mode](topic, Templates[App.mode]);
      navigator.clipboard.writeText(prompt).then(()=>Note.show('Prompt copied','ok'));
    };
    UI.templateBtn.onclick = () => {
      if (!App.mode) return;
      UI.json.value = JSON.stringify(Templates[App.mode], null, 2);
      Note.show('Template restored','ok');
    };
    UI.formatBtn.onclick = () => {
      try{ UI.json.value = JSON.stringify(JSON.parse(UI.json.value), null, 2); Note.show('JSON formatted','ok'); }
      catch(e){ Note.show('Invalid JSON','err'); }
    };
    UI.copyBtn.onclick = ()=> navigator.clipboard.writeText(UI.json.value).then(()=>Note.show('JSON copied','ok'));
    UI.saveBtn.onclick = ()=> downloadHTML();

    UI.fsBtn.onclick = () => {
      const host = document.documentElement;
      if (!document.fullscreenElement) host.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    };

    // Download this current page with inlined JSON/state
    function downloadHTML(){
      const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `AI-Visualization-SuperSuite.html`;
      a.click();
      URL.revokeObjectURL(a.href);
      Note.show('HTML saved','ok');
    }

    // TTS helper
    const Speech = {
      speak(text, gender='auto', onend){
        if (App.muted || !text) return onend?.();
        const u = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        if (gender==='male'){
          const m = voices.find(v=>/en/i.test(v.lang)&&/male/i.test(v.name)) || voices.find(v=>/en/i.test(v.lang));
          if (m) u.voice = m;
        } else if (gender==='female'){
          const f = voices.find(v=>/en/i.test(v.lang)&&/female/i.test(v.name)) || voices.find(v=>/en/i.test(v.lang));
          if (f) u.voice = f;
        }
        u.onend = onend||null;
        speechSynthesis.speak(u);
      }
    };

    // Start a run
    function startRun(){
      try{
        const data = JSON.parse(UI.json.value);
        stopRun();
        UI.stage.innerHTML = '';
        UI.legend.innerHTML = '';
        UI.mini.classList.add('hidden');
        const klass = Players[App.mode];
        App.player = new klass(data, UI.stage, UI);
        App.player.load().then(()=>{
          App.player.play?.(UI.voice.value);
          App.t0 = performance.now();
          loop();
          Note.show('Playback started','ok');
        }).catch(e=>{ console.error(e); Note.show('Load error','err');});
      }catch(e){
        console.error(e);
        Note.show('Invalid JSON','err');
      }
    }
    function stopRun(){
      cancelAnimationFrame(App.raf);
      if (App.player?.destroy) try{ App.player.destroy(); }catch(e){}
      App.player = null;
      speechSynthesis.cancel();
    }
    function loop(t){
      if (!App.player) return;
      const ms = (t||performance.now()) - App.t0;
      UI.timeTag.innerHTML = `<i class="bi bi-clock"></i> ${fmt(ms)}`;
      App.player.tick?.(ms);
      App.raf = requestAnimationFrame(loop);
    }
    function fmt(ms){
      const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s%60;
      return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
    }

    // Templates and prompts
    const Templates = {
      'graph-pro': {
        title: "EV Market — Live & Forecast",
        stream: { intervalMs: 1200, jitter: 0.03 },
        chart: {
          type: "line",
          labels: ["2022","2023","2024","2025","2026","2027","2028","2029","2030"],
          datasets: [
            { label:"EV Sales (M)", data:[10.5,14.8,21,30,40.5,51,62,69,75], color:"#8b5cf6" }
          ]
        },
        morphSequence: ["line","bar","doughnut","scatter","venn","line"],
        forecast: { horizon: 5, band: 0.12 },
        threed: { enable: true, pointSize: 0.06, elevationScale: 0.6 },
        narration: [
          "Live EV sales stream begins; watch trends update in real time.",
          "Morphing charts reveals structure hidden in a single view.",
          "3D landscape projects volume as elevation for intuitive reading.",
          "Forecast band shows plausible futures under uncertainty."
        ]
      },
      'creative-pro': {
        width: 1280, height: 720,
        layers: [
          { kind:"video", url:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4", alpha:0.7, chroma:"#00ff00" },
          { kind:"image", url:"https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1600&auto=format&fit=crop&q=80", alpha:0.25 },
          { kind:"particles", count: 180, colorA:"#06b6d4", colorB:"#f472b6" },
          { kind:"text", text:"Beyond The Product", size:72 },
          { kind:"bars", qty:48 } // audio-reactive bars (synthetic beat)
        ],
        scenes: [
          { text:"Open", narration:"Stories move people more than features. Let visuals perform the emotion.", dur:3500 },
          { text:"Chroma Key", narration:"Blend subjects with worlds via clean green-screen compositing.", dur:3500 },
          { text:"Reactive", narration:"Beats drive motion, color, and light for cinematic rhythm.", dur:3500 },
          { text:"Finale", narration:"Make meaning, then make memories. That is creative power.", dur:3500 }
        ]
      },
      'mindvoice-pro': {
        root: {
          id:"photosynthesis", title:"Photosynthesis",
          notes:"Light to chemical energy conversion.",
          script:"We traverse an idea forest; each node breathes meaning and invites paths.",
          children:[
            { id:"inputs", title:"Inputs", notes:"Light, H2O, CO2", script:"Three ingredients: light energy, water, and carbon dioxide.", children:[] },
            { id:"stages", title:"Stages", notes:"Light Reactions & Calvin", script:"Two synchronized stages cooperate across membranes and stroma.",
              children:[
                { id:"light", title:"Light Reactions", notes:"Split water; oxygen out", script:"Photon cascades lift electrons; water yields oxygen." },
                { id:"calvin", title:"Calvin Cycle", notes:"Fix CO2", script:"Carbon fixation spins sugars from captured energy." }
              ]
            },
            { id:"outputs", title:"Outputs", notes:"Glucose and O2", script:"Glucose fuels life; oxygen refreshes the air." }
          ]
        },
        physics:{ link:120, repulse:8000, damping:0.9 },
        podcast:true,
        collaborate:true
      },
      'chem-pro': {
        name:"Friedel-Crafts Acylation",
        view3D:true,
        energyCurve:[0, 20, 8, 24, 2],
        molecules:{
          acyl_chloride:{
            position:{x:-2,y:0,z:0},
            atoms:[
              {id:"c1",e:"C",x:0,y:0,z:0},{id:"o1",e:"O",x:0,y:0.6,z:0},
              {id:"cl1",e:"Cl",x:0.6,y:0,z:0},{id:"c2",e:"C",x:-0.6,y:0.2,z:0}
            ],
            bonds:[["c1","o1",2],["c1","cl1",1],["c1","c2",1]]
          },
          benzene:{
            position:{x:2,y:0,z:0},
            atoms:[
              {id:"c3",e:"C",x:0,y:-0.9,z:0},{id:"c4",e:"C",x:0.78,y:-0.45,z:0},
              {id:"c5",e:"C",x:0.78,y:0.45,z:0},{id:"c6",e:"C",x:0,y:0.9,z:0},
              {id:"c7",e:"C",x:-0.78,y:0.45,z:0},{id:"c8",e:"C",x:-0.78,y:-0.45,z:0}
            ],
            bonds:[["c3","c4",2],["c5","c6",2],["c7","c8",2],["c4","c5",1],["c6","c7",1],["c8","c3",1]]
          }
        },
        steps:[
          { title:"Lewis Acid Coordination", say:"AlCl3 coordinates to chloride.", action:"arrow", from:"acyl_chloride.cl1", to:"acyl_chloride.c1", dur:2000 },
          { title:"C–Cl Cleavage", say:"Bond weakens and breaks.", action:"break", mol:"acyl_chloride", a:"c1", b:"cl1", dur:1500 },
          { title:"Electrophilic Attack", say:"Ring pi electrons attack the acylium.", action:"arrow", from:"benzene.c3", to:"acyl_chloride.c1", dur:2000 },
          { title:"Aromaticity Restored", say:"Deprotonation regenerates aromaticity.", action:"none", dur:1500 }
        ]
      },
      'spacetime': {
        scene:"cosmos",
        galaxies: 1200,
        lensing:true,
        narrator:"Space stretches, time bends; matter writes geometry."
      },
      'biovis': {
        dnaTurns: 16,
        helixRadius: 1.2,
        bpPerTurn: 10,
        text:"Genome flows to form and function."
      },
      'timeline': {
        epochs:[
          {label:"Republic", start:-509, end:-27, color:"#60a5fa"},
          {label:"Empire", start:-27, end:476, color:"#f59e0b"},
          {label:"Byzantine", start:330, end:1453, color:"#34d399"}
        ],
        branches:[
          {from:"Empire", to:"Byzantine", when:330, weight:0.7}
        ],
        narration:"Civilizations branch like rivers with sources, deltas, and floods."
      },
      'simulator': {
        model:"SIR",
        N: 1_000_000,
        beta: 0.35,
        gamma: 0.08,
        I0: 120,
        days: 240,
        narration:"Small parameter shifts change planetary outcomes."
      }
    };

    const Prompts = {
      'graph-pro': (topic,t)=>`Generate JSON for a live, morphing, 3D-enabled data story about "${topic}". Keep keys as in template. Populate plausibly realistic time series and enable forecast.`,
      'creative-pro': (topic,t)=>`Generate JSON for a cinematic, layered video about "${topic}" with chroma key moments, particles, audio-reactive bars, and 4 scenes.`,
      'mindvoice-pro': (topic,t)=>`Generate a mindmap JSON on "${topic}" with 3+ levels, concise scripts per node, and physics metadata as in template.`,
      'chem-pro': (topic,t)=>`Generate a mechanism JSON for "${topic}" including 3D-friendly atom coordinates, steps with actions, and an energyCurve.`,
      'spacetime': (topic,t)=>`Generate cosmic JSON for "${topic}" with galaxy count, lensing flag, and a narrator line.`,
      'biovis': (topic,t)=>`Generate bio JSON for "${topic}" with DNA helix parameters and a brief text.`,
      'timeline': (topic,t)=>`Generate a historical timeline JSON for "${topic}" with epochs and branches.`,
      'simulator': (topic,t)=>`Generate a simulator JSON for "${topic}" either SIR or SEIR with parameters and days.`
    };

    // Players registry
    const Players = {
      'graph-pro': class GraphPro {
        constructor(data, mount, ui){
          this.d=data; this.mount=mount; this.ui=ui;
          this.chart=null; this.scene=null; this.renderer=null; this.camera=null; this.points=null; this.controls=null;
          this.idx=0; this.playing=true; this.ms0=0; this.nextMorphAt=4000; this.nextStreamAt=0; this.voice='auto';
        }
        async load(){
          // DOM
          this.mount.innerHTML = `
            <div style="position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px">
              <div class="glass" id="chartBox" style="position:relative">
                <canvas id="chart" style="position:absolute;inset:10px;border-radius:12px"></canvas>
              </div>
              <div class="glass" id="threeBox" style="position:relative">
                <canvas id="gl" style="position:absolute;inset:0"></canvas>
              </div>
            </div>`;
          // Chart init
          Chart.register(ChartVenn.VennDiagramController, ChartVenn.ArcSlice);
          const ctx = this.mount.querySelector('#chart').getContext('2d');
          this.chart = new Chart(ctx, this.makeChartCfg(this.d.chart.type));

          // 3D init
          const gl = this.mount.querySelector('#gl');
          this.renderer = new THREE.WebGLRenderer({canvas:gl, antialias:true});
          this.renderer.setPixelRatio(Math.min(devicePixelRatio,2));
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0x0b1020);
          const w = gl.clientWidth, h = gl.clientHeight;
          this.camera = new THREE.PerspectiveCamera(55, w/h, 0.1, 100);
          this.camera.position.set(0,2.8,4.5);
          this.controls = new THREE.OrbitControls(this.camera, gl);
          this.controls.enableDamping = true;
          this.addLights();
          this.points = this.buildPointCloud();
          this.scene.add(this.points);
          this.onResize = ()=> {
            const W = gl.clientWidth, H = gl.clientHeight;
            this.renderer.setSize(W,H,false);
            this.camera.aspect = W/H; this.camera.updateProjectionMatrix();
          };
          new ResizeObserver(this.onResize).observe(this.mount.querySelector('#threeBox'));
          this.onResize();

          // Narration
          const n = this.d.narration||[];
          const say = (i=0)=>{
            if (!this.playing || !n[i]) return;
            Speech.speak(n[i], this.voice, ()=>setTimeout(()=>say(i+1), 600));
          };
          say(0);
        }
        addLights(){
          const a = new THREE.AmbientLight(0xffffff, .7);
          const d = new THREE.DirectionalLight(0xffffff, .9); d.position.set(3,5,2);
          this.scene.add(a,d);
        }
        buildPointCloud(){
          // Map chart data into 3D landscape
          const {labels, datasets} = this.d.chart;
          const pts = [];
          const scale = this.d.threed?.elevationScale || 0.6;
          const size = this.d.threed?.pointSize || 0.05;
          datasets.forEach((ds, di)=>{
            ds.data.forEach((v, i)=>{
              const x = (i - (labels.length-1)/2) * 0.6;
              const z = (di - (datasets.length-1)/2) * 0.6;
              const y = Math.max(0, Math.pow(v, .5)*0.15) * scale;
              pts.push({x,y,z,color:ds.color||'#8b5cf6'});
            });
          });
          const geo = new THREE.BufferGeometry();
          const arr = new Float32Array(pts.length*3);
          const col = new Float32Array(pts.length*3);
          pts.forEach((p,i)=>{
            arr[i*3+0]=p.x; arr[i*3+1]=p.y; arr[i*3+2]=p.z;
            const c = new THREE.Color(p.color);
            col[i*3+0]=c.r; col[i*3+1]=c.g; col[i*3+2]=c.b;
          });
          geo.setAttribute('position', new THREE.BufferAttribute(arr,3));
          geo.setAttribute('color', new THREE.BufferAttribute(col,3));
          const mat = new THREE.PointsMaterial({size: this.d.threed?.pointSize||0.06, vertexColors:true});
          return new THREE.Points(geo, mat);
        }
        makeChartCfg(type){
          const data = {
            labels: this.d.chart.labels,
            datasets: this.d.chart.datasets.map(ds=>({
              label: ds.label, data:[...ds.data],
              borderColor: ds.color || '#8b5cf6',
              backgroundColor: (ds.color||'#8b5cf6')+'55',
              tension:.35
            }))
          };
          const options = {
            responsive:true, maintainAspectRatio:false, animation:{duration:700},
            plugins:{ legend:{labels:{color:'#e5e7eb'}}, title:{display:true,text:this.d.title||'',color:'#e5e7eb'} },
            scales: type==='doughnut'||type==='venn'? {} : { x:{ticks:{color:'#cbd5e1'}}, y:{ticks:{color:'#cbd5e1'}} }
          };
          let cfg = { type, data, options };
          if (type==='venn'){
            cfg = {
              type:'venn',
              data:{ labels:['A','B'], datasets:[{data:[{sets:['A'],value:3},{sets:['B'],value:4},{sets:['A','B'],value:2}]}] },
              options
            };
          }
          return cfg;
        }
        morph(){
          this.idx = (this.idx+1) % this.d.morphSequence.length;
          const targetType = this.d.morphSequence[this.idx];
          this.chart.destroy();
          const ctx = this.mount.querySelector('#chart').getContext('2d');
          this.chart = new Chart(ctx, this.makeChartCfg(targetType));
        }
        stream(){
          // jitter update
          const ds = this.d.chart.datasets[0];
          const last = ds.data[ds.data.length-1];
          const delta = (Math.random()-.5) * (this.d.stream?.jitter||0.03) * Math.max(1,last);
          ds.data.shift();
          ds.data.push(Math.max(0, last + delta));
          this.chart.update('none');
          // update 3D points
          this.scene.remove(this.points);
          this.points = this.buildPointCloud();
          this.scene.add(this.points);
        }
        forecastOverlay(){
          // Simple linear regression forecast
          const ds = this.d.chart.datasets[0].data;
          const n = ds.length; const xs = [...Array(n).keys()];
          const mean = (a)=>a.reduce((s,x)=>s+x,0)/a.length;
          const mx = mean(xs), my = mean(ds);
          const b = xs.reduce((s,i)=>s+(i-mx)*(ds[i]-my),0) / xs.reduce((s,i)=>s+(i-mx)*(i-mx),0);
          const a = my - b*mx;
          const extra = this.d.forecast?.horizon || 5;
          const band = this.d.forecast?.band || 0.1;
          const allX = [...xs, ...[...Array(extra).keys()].map(i=>n+i)];
          const yhat = allX.map(i=>a + b*i);
          const min = yhat.map(v=>v*(1-band)), max = yhat.map(v=>v*(1+band));

          // draw translucent band on top of chart
          const ctx = this.mount.querySelector('#chart').getContext('2d');
          const W = ctx.canvas.width, H = ctx.canvas.height;
          const px = i => (i / (allX.length-1)) * (W-40) + 20;
          const minV = Math.min(...min), maxV = Math.max(...max);
          const py = v => H-20 - (v-minV)/(maxV-minV) * (H-60);
          ctx.save(); ctx.globalAlpha=.2; ctx.fillStyle='#22d3ee';
          ctx.beginPath();
          ctx.moveTo(px(0), py(min[0]));
          for (let i=1;i<allX.length;i++) ctx.lineTo(px(i), py(min[i]));
          for (let i=allX.length-1;i>=0;i--) ctx.lineTo(px(i), py(max[i]));
          ctx.closePath(); ctx.fill(); ctx.restore();
        }
        play(voice){ this.voice = voice||'auto'; }
        toggle(){ this.playing = !this.playing; }
        prev(){ this.morph(); }
        next(){ this.morph(); }
        tick(ms){
          // animate 3D
          this.controls?.update();
          this.points?.rotation.set(0, ms*0.0001, 0);
          this.renderer?.render(this.scene, this.camera);

          if (!this.playing) return;
          if (ms>this.nextStreamAt){ this.stream(); this.nextStreamAt = ms + (this.d.stream?.intervalMs||1200); }
          if (ms>this.nextMorphAt){ this.morph(); this.nextMorphAt = ms + 6000; }
          // forecast overlay occasionally
          if (Math.floor(ms/1500)%5===0) this.forecastOverlay();
        }
        destroy(){
          this.chart?.destroy();
          this.renderer?.dispose?.();
          this.scene = this.camera = this.points = this.controls = null;
        }
      },

      'creative-pro': class CreativePro {
        constructor(d,mount,ui){ this.d=d; this.mount=mount; this.ui=ui; this.cv=null; this.cx=null; this.assets=new Map(); this.scn=0; this.playing=true; this.ms0=0; this.beat=0; this.voice='auto'; }
        async load(){
          this.mount.innerHTML = `<canvas id="cv"></canvas>`;
          this.cv = this.mount.querySelector('#cv'); this.cx = this.cv.getContext('2d');
          this.resize = ()=>{ this.cv.width = this.mount.clientWidth; this.cv.height = this.mount.clientHeight; };
          new ResizeObserver(this.resize).observe(this.mount); this.resize();

          // preload assets
          await Promise.all(this.d.layers.map(async L=>{
            if (L.kind==='image'){
              const img = new Image(); img.crossOrigin='anonymous';
              await new Promise(res=>{ img.onload=res; img.onerror=res; img.src=L.url; });
              this.assets.set(L.url, img);
            }else if (L.kind==='video'){
              const v = document.createElement('video'); v.src=L.url; v.loop=true; v.muted=true; await v.play().catch(()=>{});
              this.assets.set(L.url, v);
            }
          }));

          // narration
          const speak = (i=0)=>{
            if (!this.playing||!this.d.scenes[i]) return;
            Speech.speak(this.d.scenes[i].narration, this.voice, ()=> setTimeout(()=>speak(i+1), 600));
          };
          speak(0);
        }
        play(voice){ this.voice=voice||'auto'; }
        toggle(){ this.playing=!this.playing; }
        prev(){ this.scn = Math.max(0, this.scn-1); }
        next(){ this.scn = Math.min(this.d.scenes.length-1, this.scn+1); }
        chromaKeyDraw(v, key='#00ff00'){
          const {cx,cv} = this;
          const vw = v.videoWidth||cv.width, vh = v.videoHeight||cv.height;
          const r = Math.max(cv.width/vw, cv.height/vh);
          const w = vw*r, h = vh*r, x = (cv.width-w)/2, y=(cv.height-h)/2;
          cx.drawImage(v, x,y,w,h);
          const img = cx.getImageData(x,y,w,h), data = img.data;
          const [kr,kg,kb] = key.match(/[0-9a-f]{2}/gi).map(h=>parseInt(h,16));
          for (let i=0;i<data.length;i+=4){
            const dr=data[i]-kr,dg=data[i+1]-kg,db=data[i+2]-kb;
            const dist = Math.sqrt(dr*dr+dg*dg+db*db);
            if (dist<140) data[i+3]=0;
          }
          cx.putImageData(img,x,y);
        }
        tick(ms){
          const {cx,cv} = this; cx.clearRect(0,0,cv.width,cv.height);
          // synthetic beat
          const beat = (Math.sin(ms*0.006)+1)*.5;
          // draw layers
          for (const L of this.d.layers){
            cx.save(); cx.globalAlpha = L.alpha??1;
            if (L.kind==='image'){
              const img = this.assets.get(L.url); if (img){
                const r = Math.max(cv.width/img.width, cv.height/img.height);
                const w=img.width*r, h=img.height*r, x=(cv.width-w)/2,y=(cv.height-h)/2;
                cx.filter = `blur(${2+beat*3}px)`;
                cx.drawImage(img,x,y,w,h);
                cx.filter = 'none';
              }
            }else if (L.kind==='video'){
              const v = this.assets.get(L.url); if (v){
                this.chromaKeyDraw(v, L.chroma||'#00ff00');
              }
            }else if (L.kind==='particles'){
              const N=L.count||150;
              for (let i=0;i<N;i++){
                const t = (i*37.2+ms*.0006);
                const x = (Math.sin(t*2.1)+1)*.5*cv.width;
                const y = (Math.cos(t*1.7)+1)*.5*cv.height;
                const g = cx.createRadialGradient(x,y,0,x,y,60+beat*40);
                g.addColorStop(0,L.colorA||'#06b6d4'); g.addColorStop(1,(L.colorB||'#f472b6')+'00');
                cx.fillStyle=g; cx.beginPath(); cx.arc(x,y, 40+beat*24, 0, Math.PI*2); cx.fill();
              }
            }else if (L.kind==='bars'){
              const Q=L.qty||48; const w=cv.width/Q, base=cv.height*.75;
              for (let i=0;i<Q;i++){
                const h = (0.2+0.8*Math.abs(Math.sin(ms*0.01+i*0.32)))* (cv.height*0.3);
                cx.fillStyle = `hsl(${(i*7+ms*.05)%360} 80% 60%)`;
                cx.fillRect(i*w+4, base-h, w-8, h);
              }
            }else if (L.kind==='text'){
              cx.textAlign='center'; cx.textBaseline='middle';
              cx.font=`800 ${L.size||64}px Inter, sans-serif`;
              cx.fillStyle='rgba(255,255,255,.95)';
              cx.fillText(L.text||'', cv.width/2, cv.height*.2);
            }
            cx.restore();
          }
        }
        destroy(){ this.assets.forEach(v=>{ try{ v.pause?.(); }catch{} }); this.assets.clear(); }
      },

      'mindvoice-pro': class MindVoice {
        constructor(d,m,u){ this.d=d; this.mount=m; this.ui=u; this.nodes=[]; this.links=[]; this.playing=true; this.voice='auto'; this.bc=null; this.p=null; }
        async load(){
          this.mount.innerHTML = `<div id="mmWrap" style="position:absolute;inset:0"></div>`;
          const wrap = this.mount.querySelector('#mmWrap');
          const self=this;
          new p5(function(p){
            self.p=p;
            const cam = {x:0,y:0,zoom:1,tx:0,ty:0,tz:1};
            let dragging=false,lx=0,ly=0;
            p.setup=()=>{ p.createCanvas(wrap.clientWidth, wrap.clientHeight); self.build(); p.textFont('Inter'); };
            p.windowResized=()=>{ p.resizeCanvas(wrap.clientWidth, wrap.clientHeight); };
            p.mousePressed=()=>{ dragging=true; lx=p.mouseX; ly=p.mouseY; };
            p.mouseReleased=()=>{ dragging=false; };
            p.mouseWheel=e=>{ const z = e.delta>0? .9:1.1; cam.tz = p.constrain(cam.tz*z, .4, 2.2); };
            p.draw=()=>{
              // camera lerp
              cam.x = p.lerp(cam.x, cam.tx, .15); cam.y=p.lerp(cam.y, cam.ty, .15); cam.zoom=p.lerp(cam.zoom, cam.tz, .15);
              if (dragging){ cam.tx -= (p.mouseX-lx)/cam.zoom; cam.ty -= (p.mouseY-ly)/cam.zoom; lx=p.mouseX; ly=p.mouseY; }
              // physics
              self.stepPhysics();
              // render
              p.background(8,12,20); p.push(); p.translate(p.width/2, p.height/2); p.scale(cam.zoom); p.translate(-cam.x,-cam.y);
              // links
              p.stroke(90,130,255,140); p.strokeWeight(2);
              self.links.forEach(L=>{ p.line(L.a.x,L.a.y,L.b.x,L.b.y); });
              // nodes
              self.nodes.forEach(n=>{
                p.noStroke(); p.fill(n.color);
                p.ellipse(n.x,n.y,n.size);
                p.fill(255); p.textAlign(p.CENTER,p.CENTER); p.textSize(n.size>.1?14:12);
                p.text(n.title, n.x, n.y);
              });
              p.pop();
            };
          });
          if (this.d.podcast){
            const liner = [];
            this.walk(this.d.root, node=> node.script && liner.push(node.script));
            const recite = (i=0)=>{
              if (!this.playing||!liner[i]) return;
              Speech.speak(liner[i], this.voice, ()=> setTimeout(()=>recite(i+1), 500));
            };
            recite(0);
          }
          if (this.d.collaborate){
            this.bc = new BroadcastChannel('mindvoice-room');
            this.bc.onmessage = ev=>{
              if (ev.data?.type==='drag' && this.nodes[ev.data.i]){
                const n = this.nodes[ev.data.i]; n.x = ev.data.x; n.y = ev.data.y;
              }
            };
          }
        }
        play(v){ this.voice=v||'auto'; }
        toggle(){ this.playing=!this.playing; }
        prev(){} next(){}
        build(){
          const colors = ['#8b5cf6','#06b6d4','#f59e0b','#10b981','#ef4444','#3b82f6'];
          const nodes=[]; const links=[];
          const place=(node, depth=0, angle=0, parent=null)=>{
            const r = 180 + depth*70, a = angle;
            const p = parent? {x: parent.x + Math.cos(a)*r, y: parent.y + Math.sin(a)*r} : {x:0,y:0};
            const obj = {title:node.title, size: 90-Math.min(60,depth*12), x:p.x, y:p.y, vx:0, vy:0, color:colors[depth%colors.length], children:[]};
            nodes.push(obj);
            if (parent) links.push({a:obj,b:parent});
            const nchild = (node.children||[]).length;
            (node.children||[]).forEach((c,i)=> place(c, depth+1, angle + (i-(nchild-1)/2)* (Math.PI/(1.2+depth*.35)), obj));
          };
          place(this.d.root,0,0,null);
          this.nodes=nodes; this.links=links;
        }
        stepPhysics(){
          const L = this.d.physics?.link||120;
          const R = this.d.physics?.repulse||8000;
          const D = this.d.physics?.damping||0.9;
          // spring
          this.links.forEach(e=>{
            const dx = e.b.x-e.a.x, dy=e.b.y-e.a.y, d=Math.max(0.001, Math.hypot(dx,dy));
            const f = (d-L)*.02;
            const fx = f*dx/d, fy=f*dy/d;
            e.a.vx += fx; e.a.vy += fy; e.b.vx -= fx; e.b.vy -= fy;
          });
          // repulsion
          for (let i=0;i<this.nodes.length;i++){
            for (let j=i+1;j<this.nodes.length;j++){
              const a=this.nodes[i], b=this.nodes[j];
              const dx=b.x-a.x, dy=b.y-a.y, r2=dx*dx+dy*dy+25;
              const f= R / r2;
              const l = Math.sqrt(r2);
              a.vx -= f*dx/l; a.vy -= f*dy/l; b.vx += f*dx/l; b.vy += f*dy/l;
            }
          }
          // integrate
          this.nodes.forEach((n,i)=>{
            n.vx*=D; n.vy*=D; n.x+=n.vx*0.5; n.y+=n.vy*0.5;
          });
        }
        walk(node, fn){ fn(node); (node.children||[]).forEach(c=>this.walk(c, fn)); }
        destroy(){ this.bc?.close?.(); }
      },

      'chem-pro': class ChemPro {
        constructor(d,m,u){ this.d=d; this.mount=m; this.ui=u; this.renderer=null; this.scene=null; this.camera=null; this.controls=null; this.ms=0; this.playing=true; this.voice='auto'; this.energyCtx=null; }
        async load(){
          this.mount.innerHTML = `
            <div style="position:absolute;inset:0;display:grid;grid-template-columns:2fr 1fr;gap:10px;padding:10px">
              <div id="th3" class="glass" style="position:relative"><canvas id="c3d" style="position:absolute;inset:0"></canvas></div>
              <div class="glass" style="position:relative">
                <div class="flex" style="padding:10px;gap:6px"><div class="tag">Mechanism</div></div>
                <div id="steps" style="padding:10px;display:flex;flex-direction:column;gap:6px;max-height:calc(100% - 140px);overflow:auto"></div>
                <div class="mini" style="position:absolute;left:10px;right:10px;bottom:10px">
                  <h5>Energy Profile</h5>
                  <canvas id="energy" width="440" height="160"></canvas>
                </div>
              </div>
            </div>`;
          // Three
          const canvas = this.mount.querySelector('#c3d');
          this.renderer = new THREE.WebGLRenderer({canvas, antialias:true});
          this.renderer.setPixelRatio(Math.min(devicePixelRatio,2));
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0x0b0f1e);
          this.camera = new THREE.PerspectiveCamera(55, 1, .1, 100);
          this.camera.position.set(0,2.3,6);
          this.controls = new THREE.OrbitControls(this.camera, canvas);
          this.controls.enableDamping=true;
          const box = this.mount.querySelector('#th3');
          const resize = ()=>{ const w=box.clientWidth, h=box.clientHeight; this.renderer.setSize(w,h,false); this.camera.aspect=w/h; this.camera.updateProjectionMatrix(); };
          new ResizeObserver(resize).observe(box); resize();
          this.scene.add(new THREE.AmbientLight(0xffffff,.7));
          const dir = new THREE.DirectionalLight(0xffffff,.9); dir.position.set(3,5,2); this.scene.add(dir);

          // Build molecules
          this.molGroup = new THREE.Group();
          this.scene.add(this.molGroup);
          const byElem = {C:0x404040,O:0xef4444,Cl:0x16a34a,H:0xffffff,Al:0x6b7280};
          const sph = new THREE.SphereGeometry(.14, 32, 16);
          const cyl = new THREE.CylinderGeometry(.06,.06,1,24);
          const balls={};
          Object.entries(this.d.molecules).forEach(([key, mol])=>{
            const root = new THREE.Group(); root.position.set(mol.position.x, mol.position.y, mol.position.z);
            // atoms
            mol.atoms.forEach(a=>{
              const m = new THREE.Mesh(sph, new THREE.MeshStandardMaterial({color: byElem[a.e]||0x94a3b8, metalness:.2, roughness:.3}));
              m.position.set(a.x,a.y,a.z); m.userData={key, id:a.id}; root.add(m); balls[`${key}.${a.id}`]=m;
            });
            // bonds
            mol.bonds.forEach(([a,b,order])=>{
              const A = balls[`${key}.${a}`].position.clone();
              const B = balls[`${key}.${b}`].position.clone();
              const center = new THREE.Vector3().addVectors(A,B).multiplyScalar(.5);
              const len = A.distanceTo(B);
              for (let k=0;k<order;k++){
                const off = (k-(order-1)/2)*0.09;
                const axis = new THREE.Vector3().subVectors(B,A).normalize();
                const perp = new THREE.Vector3(0,1,0).cross(axis).normalize().multiplyScalar(off);
                const mesh = new THREE.Mesh(cyl, new THREE.MeshStandardMaterial({color:0x9ca3af, metalness:.3, roughness:.3}));
                mesh.position.copy(center).add(perp);
                mesh.scale.set(1,len,1);
                mesh.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0), axis);
                root.add(mesh);
              }
            });
            this.molGroup.add(root);
          });

          // Steps
          const steps = this.mount.querySelector('#steps');
          this.idx=0;
          this.d.steps.forEach((s,i)=>{
            const b=document.createElement('button'); b.className='btn'; b.textContent = `${i+1}. ${s.title}`;
            b.onclick=()=>{ this.idx=i; this.stepNarrate(); };
            steps.appendChild(b);
          });
          this.stepNarrate();

          // Energy profile
          this.energyCtx = this.mount.querySelector('#energy').getContext('2d');
          this.drawEnergy(0);
        }
        stepNarrate(){
          const s=this.d.steps[this.idx];
          Speech.speak(s.say, this.voice, null);
        }
        drawEnergy(progress){
          const ctx=this.energyCtx; if (!ctx) return;
          const W=ctx.canvas.width,H=ctx.canvas.height; ctx.clearRect(0,0,W,H);
          const arr = this.d.energyCurve; const n=arr.length;
          const min=Math.min(...arr), max=Math.max(...arr);
          const x=i=> 20 + (i/(n-1))*(W-40);
          const y=v=> H-20 - ((v-min)/(max-min||1))*(H-50);
          ctx.lineWidth=3; ctx.strokeStyle='#22d3ee'; ctx.beginPath(); ctx.moveTo(x(0), y(arr[0]));
          for(let i=1;i<n;i++) ctx.lineTo(x(i), y(arr[i]));
          ctx.stroke();
          // marker
          const f = this.idx/(this.d.steps.length-1||1);
          const xi = 20 + f*(W-40);
          ctx.fillStyle='#f59e0b'; ctx.beginPath(); ctx.arc(xi, y(arr[Math.round(f*(n-1))]), 6, 0, Math.PI*2); ctx.fill();
        }
        play(v){ this.voice=v||'auto'; }
        toggle(){ this.playing=!this.playing; }
        prev(){ this.idx=Math.max(0,this.idx-1); this.stepNarrate(); this.drawEnergy(); }
        next(){ this.idx=Math.min(this.d.steps.length-1,this.idx+1); this.stepNarrate(); this.drawEnergy(); }
        tick(ms){
          this.controls?.update();
          this.molGroup?.rotation.set(0, ms*0.0002, 0);
          this.renderer?.render(this.scene,this.camera);
        }
        destroy(){ this.renderer?.dispose?.(); this.scene=null; }
      },

      'spacetime': class SpaceTime {
        constructor(d,m,u){ this.d=d; this.mount=m; this.ui=u; }
        async load(){
          this.mount.innerHTML = `<canvas id="cos"></canvas>`;
          const cv=this.mount.querySelector('#cos'), gl=cv.getContext('2d');
          const resize = ()=>{ cv.width=this.mount.clientWidth; cv.height=this.mount.clientHeight; };
          new ResizeObserver(resize).observe(this.mount); resize();
          this.starfield = [...Array(this.d.galaxies||800)].map(()=>({
            x:Math.random()*cv.width, y:Math.random()*cv.height, z:Math.random(), c:`hsl(${Math.random()*360} 70% 70%)`
          }));
          Speech.speak(this.d.narrator||'', 'auto');
          this.draw=(t)=>{
            gl.clearRect(0,0,cv.width,cv.height);
            this.starfield.forEach(s=>{
              const r = (1-s.z)*2.5;
              gl.fillStyle=s.c; gl.globalAlpha=.6+s.z*.4;
              gl.beginPath(); gl.arc(s.x, s.y, r, 0, Math.PI*2); gl.fill();
              // lensing shimmer
              s.x += (Math.sin((s.y+t*.0006)*.02)-.5)*.2;
              s.y += (Math.cos((s.x+t*.0004)*.02)-.5)*.2;
            });
          };
        }
        play(){} toggle(){ } prev(){} next(){}
        tick(ms){ this.draw?.(ms); }
        destroy(){}
      },

      'biovis': class BioVis {
        constructor(d,m,u){ this.d=d; this.mount=m; }
        async load(){
          this.mount.innerHTML = `<canvas id="dna"></canvas>`;
          const cv=this.mount.querySelector('#dna'); const gl=cv.getContext('2d');
          const resize=()=>{ cv.width=this.mount.clientWidth; cv.height=this.mount.clientHeight; };
          new ResizeObserver(resize).observe(this.mount); resize();
          Speech.speak(this.d.text||'', 'auto');
          this.draw=(t)=>{
            gl.clearRect(0,0,cv.width,cv.height);
            const R=this.d.helixRadius||1.2, turns=this.d.dnaTurns||12, bp=this.d.bpPerTurn||10;
            const H = cv.height*0.7, cx = cv.width/2, cy=cv.height/2;
            for (let i=0;i<turns*bp;i++){
              const th = i/bp * Math.PI*2 + t*.0012;
              const x1 = cx + Math.cos(th)*R*80, x2 = cx - Math.cos(th)*R*80;
              const y = cy + (i/(turns*bp)-.5)*H;
              const size = 6 + 4*Math.sin(th);
              gl.fillStyle = `hsl(${(i*7+t*.05)%360} 80% 60%)`;
              gl.beginPath(); gl.arc(x1, y, size, 0, Math.PI*2); gl.fill();
              gl.beginPath(); gl.arc(x2, y, size, 0, Math.PI*2); gl.fill();
              gl.strokeStyle='rgba(255,255,255,.35)';
              gl.beginPath(); gl.moveTo(x1,y); gl.lineTo(x2,y); gl.stroke();
            }
          };
        }
        play(){} toggle(){} prev(){} next(){}
        tick(ms){ this.draw?.(ms); }
        destroy(){}
      },

      'timeline': class Timeline {
        constructor(d,m,u){ this.d=d; this.mount=m; }
        async load(){
          this.mount.innerHTML = `<canvas id="tl"></canvas>`;
          const cv=this.mount.querySelector('#tl'); const gl=cv.getContext('2d');
          const resize=()=>{ cv.width=this.mount.clientWidth; cv.height=this.mount.clientHeight; };
          new ResizeObserver(resize).observe(this.mount); resize();
          Speech.speak(this.d.narration||'', 'auto');
          this.draw=()=>{
            gl.clearRect(0,0,cv.width,cv.height);
            const min = Math.min(...this.d.epochs.map(e=>e.start));
            const max = Math.max(...this.d.epochs.map(e=>e.end));
            const x = v => (v-min)/(max-min||1) * (cv.width-120) + 60;
            const Y = (i)=> 80 + i*80;
            gl.strokeStyle='#475569';
            gl.lineWidth=2; gl.beginPath(); gl.moveTo(60, 40); gl.lineTo(cv.width-60, 40);
            gl.stroke();
            this.d.epochs.forEach((e,i)=>{
              const start = x(e.start), end = x(e.end);
              gl.fillStyle = e.color + '55';
              gl.strokeStyle = e.color;
              gl.lineWidth=4;
              gl.beginPath(); gl.moveTo(start, Y(i)); gl.lineTo(end, Y(i)); gl.stroke();
              gl.fillRect(start-10, Y(i)-6, 20, 12);
              gl.fillStyle=e.color; gl.fillRect(end-10, Y(i)-6, 20, 12);
              gl.fillStyle='white'; gl.textAlign='center'; gl.font='bold 14px Inter';
              gl.fillText(e.label, (start+end)/2, Y(i)+4);
            });
            // branches
            this.d.branches?.forEach(b=>{
              const e1 = this.d.epochs.find(e=>e.label===b.from);
              const e2 = this.d.epochs.find(e=>e.label===b.to);
              if (e1&&e2){
                const x1 = x(e1.start + (e1.end-e1.start)*(b.when-e1.start)/(e1.end-e1.start||1));
                const x2 = x(e2.start);
                const y1 = Y(this.d.epochs.findIndex(e=>e.label===b.from));
                const y2 = Y(this.d.epochs.findIndex(e=>e.label===b.to));
                gl.strokeStyle='#f472b6'; gl.lineWidth=2; gl.setLineDash([5,5]);
                gl.beginPath(); gl.moveTo(x1,y1); gl.lineTo(x2,y2); gl.stroke(); gl.setLineDash([]);
              }
            });
          };
          this.draw();
        }
        play(){} toggle(){} prev(){} next(){}
        tick(ms){ this.draw?.(); }
        destroy(){}
      },

      'simulator': class Simulator {
        constructor(d,m,u){ this.d=d; this.mount=m; this.ui=u; this.canvas=null; this.ctx=null; this.running=false; this.params={}; }
        async load(){
          // SIR model parameters
          this.params = {
            N: this.d.N || 1_000_000,
            beta: this.d.beta || 0.35,
            gamma: this.d.gamma || 0.08,
            I0: this.d.I0 || 120,
            S0: this.d.N - this.d.I0,
            R0: 0,
            days: this.d.days || 240
          };
          this.mount.innerHTML = `
            <div style="position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px">
              <div class="glass" id="simVis"></div>
              <div class="glass" style="padding:10px">
                <h5>Live Parameters</h5>
                <div class="row"><label>Beta: </label><input type="range" id="beta" min="0.1" max="1" step="0.01" value="${this.params.beta}" style="flex:1"></div>
                <div class="row"><label>Gamma: </label><input type="range" id="gamma" min="0.01" max="0.2" step="0.01" value="${this.params.gamma}" style="flex:1"></div>
                <div class="row"><label>Initial Infected: </label><input type="range" id="i0" min="10" max="10000" step="10" value="${this.params.I0}" style="flex:1"></div>
                <div class="row"><button class="btn pri" id="resetBtn">Reset Sim</button><button class="btn ok" id="runBtn2">Run Forward</button></div>
                <div id="stats" style="margin-top:12px;font-size:12px;color:var(--muted)"></div>
              </div>
            </div>`;
          this.canvas = this.mount.querySelector('#simVis');
          this.ctx = this.canvas.getContext('2d');
          const resize = ()=>{ this.canvas.width = this.canvas.clientWidth; this.canvas.height = this.canvas.clientHeight; };
          new ResizeObserver(resize).observe(this.canvas); resize();
          // controls
          this.mount.querySelector('#beta').oninput = e=>{ this.params.beta = +e.target.value; this.running && this.reset(); };
          this.mount.querySelector('#gamma').oninput = e=>{ this.params.gamma = +e.target.value; this.running && this.reset(); };
          this.mount.querySelector('#i0').oninput = e=>{ this.params.I0 = +e.target.value; this.running && this.reset(); };
          this.mount.querySelector('#resetBtn').onclick = ()=> this.reset();
          this.mount.querySelector('#runBtn2').onclick = ()=> this.running ? this.pause() : this.run();
          // init
          Speech.speak(this.d.narration||'', 'auto');
          this.reset();
          this.draw();
        }
        reset(){
          this.running = false;
          this.params.S0 = this.params.N - this.params.I0;
          this.params.R0 = 0;
          this.day = 0;
          this.data = { S:[this.params.S0], I:[this.params.I0], R:[this.params.R0] };
        }
        run(){ this.running = true; this.animate(); }
        pause(){ this.running = false; }
        step(){
          const {S,I,R,N,beta,gamma} = this.params;
          const s = S/N, i = I/N, r = R/N;
          const ds = -beta*s*i, di = beta*s*i - gamma*i, dr = gamma*i;
          this.params.S = Math.max(0, S + ds*N);
          this.params.I = Math.max(0, I + di*N);
          this.params.R = Math.max(0, R + dr*N);
          this.data.S.push(this.params.S);
          this.data.I.push(this.params.I);
          this.data.R.push(this.params.R);
          this.day++;
          if (this.day >= this.params.days || this.params.I < 1) this.running = false;
          const stats = this.mount.querySelector('#stats');
          stats.innerHTML = `Day ${this.day}: S=${Math.round(this.params.S).toLocaleString()}, I=${Math.round(this.params.I).toLocaleString()}, R=${Math.round(this.params.R).toLocaleString()}`;
        }
        animate(){
          if (!this.running) return;
          this.step();
          this.draw();
          requestAnimationFrame(()=>this.animate());
        }
        draw(){
          const {ctx,canvas} = this;
          const W=canvas.width, H=canvas.height;
          ctx.clearRect(0,0,W,H);
          const maxD = Math.max(...Object.values(this.data).map(d=>Math.max(...d)));
          const x=d=> (d/this.day||1) * (W-40) + 20;
          const y=v=> H-20 - (v/maxD||1) * (H-80);
          const drawCurve = (data, col)=>{
            ctx.strokeStyle = col; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(20, y(data[0]));
            data.forEach((v,i)=> i>0 && ctx.lineTo(x(i), y(v)));
            ctx.stroke();
          };
          drawCurve(this.data.S, '#10b981'); // Susceptible green
          drawCurve(this.data.I, '#ef4444'); // Infected red
          drawCurve(this.data.R, '#9ca3af'); // Recovered gray
          // legend
          ctx.fillStyle='#10b981'; ctx.fillRect(20,20,12,12); ctx.fillStyle='white'; ctx.font='12px Inter'; ctx.textAlign='left'; ctx.fillText('S', 36, 30);
          ctx.fillStyle='#ef4444'; ctx.fillRect(20,40,12,12); ctx.fillText('I', 36, 50);
          ctx.fillStyle='#9ca3af'; ctx.fillRect(20,60,12,12); ctx.fillText('R', 36, 70);
        }
        play(){} toggle(){ this.running = !this.running; if (this.running) this.animate(); } prev(){ this.reset(); } next(){ this.step(); this.draw(); }
        tick(ms){ if (this.running) this.draw(); }
        destroy(){ this.running=false; }
      }
    };

    // Init
    if ('BroadcastChannel' in window) console.log('Collaboration ready');
    speechSynthesis.onvoiceschanged = ()=> console.log('TTS ready:', speechSynthesis.getVoices().length, 'voices');
    document.addEventListener('keydown', e=>{
      if (e.target.tagName==='TEXTAREA') return;
      if (e.code==='Space') e.preventDefault() && (UI.playBtn.onclick?.());
      if (e.code==='ArrowLeft') UI.prevBtn.onclick?.();
      if (e.code==='ArrowRight') UI.nextBtn.onclick?.();
    });

    // Auto-select first mode for demo
    setTimeout(()=> document.querySelector('.card').click(), 800);
  </script>
</body>
</html>
